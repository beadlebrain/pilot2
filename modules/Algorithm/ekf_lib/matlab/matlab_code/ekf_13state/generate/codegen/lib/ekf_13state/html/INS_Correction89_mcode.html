<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="37,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T14U3">X</span> <span class="var type1" id="S3T25U4">P</span>]=INS_Correction(<span class="var type1" id="S4T9U7">Mag_data</span>,<span class="var type1" id="S5T9U8">Pos</span>,<span class="var type1" id="S6T9U9">Vel</span>,<span class="mxinfo" id="T14:U6"><span class="mxinfo" id="T14:U7"><span class="var type1" id="S2T14U10">X</span></span></span>,<span class="var type1" id="S7T33U11">R</span>,<span class="mxinfo" id="T25:U10"><span class="mxinfo" id="T25:U11"><span class="var type1" id="S3T25U12">P</span></span></span>,<span class="var type1" id="S8T9U13">Be</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="37,2" id="srcline2"> 2</a></span><span class="line"><span class="mxinfo" id="T2:U14"><span class="var type1" id="S9T2U16">q0</span>=<span class="mxinfo" id="T2:U16"><span class="var type1" id="S2T14U18">X</span>(<span class="mxinfo" id="T4:U18">7</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo" id="T2:U19"><span class="var type1" id="S10T2U22">q1</span>=<span class="mxinfo" id="T2:U21"><span class="var type1" id="S2T14U24">X</span>(<span class="mxinfo" id="T4:U23">8</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,4" id="srcline4"> 4</a></span><span class="line"><span class="mxinfo" id="T2:U24"><span class="var type1" id="S11T2U28">q2</span>=<span class="mxinfo" id="T2:U26"><span class="var type1" id="S2T14U30">X</span>(<span class="mxinfo" id="T4:U28">9</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo" id="T2:U29"><span class="var type1" id="S12T2U34">q3</span>=<span class="mxinfo" id="T2:U31"><span class="var type1" id="S2T14U36">X</span>(<span class="mxinfo" id="T4:U33">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo" id="T18:U34"><span class="var type1" id="S13T18U40">Z</span>=<span class="mxinfo" id="T18:U36">zeros(<span class="mxinfo" id="T4:U37">8</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo" id="T4:U38"><span class="mxinfo" id="T4:U39"><span class="var type1" id="S13T18U48">Z</span>(<span class="mxinfo" id="T4:U41">1</span>)</span>=<span class="mxinfo" id="T2:U42"><span class="var type1" id="S5T9U51">Pos</span>(<span class="mxinfo" id="T4:U44">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T4:U45"><span class="mxinfo" id="T4:U46"><span class="var type1" id="S13T18U56">Z</span>(<span class="mxinfo" id="T4:U48">2</span>)</span>=<span class="mxinfo" id="T2:U49"><span class="var type1" id="S5T9U59">Pos</span>(<span class="mxinfo" id="T4:U51">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T4:U52"><span class="mxinfo" id="T4:U53"><span class="var type1" id="S13T18U64">Z</span>(<span class="mxinfo" id="T4:U55">3</span>)</span>=<span class="mxinfo" id="T2:U56"><span class="var type1" id="S5T9U67">Pos</span>(<span class="mxinfo" id="T4:U58">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T4:U59"><span class="mxinfo" id="T4:U60"><span class="var type1" id="S13T18U72">Z</span>(<span class="mxinfo" id="T4:U62">4</span>)</span>=<span class="mxinfo" id="T2:U63"><span class="var type1" id="S6T9U75">Vel</span>(<span class="mxinfo" id="T4:U65">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo" id="T4:U66"><span class="mxinfo" id="T4:U67"><span class="var type1" id="S13T18U80">Z</span>(<span class="mxinfo" id="T4:U69">5</span>)</span>=<span class="mxinfo" id="T2:U70"><span class="var type1" id="S6T9U83">Vel</span>(<span class="mxinfo" id="T4:U72">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,13" id="srcline13">13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,14" id="srcline14">14</a></span><span class="line"><span class="comment">% %% do lots of things to remove megnetic Z value</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo" id="T1:U73"><span class="var type1" id="S15T1U87">q_now</span>=<span class="mxinfo" id="T1:U75">[<span class="var type1" id="S9T2U90">q0</span>;<span class="var type1" id="S10T2U92">q1</span>;<span class="var type1" id="S11T2U94">q2</span>;<span class="var type1" id="S12T2U96">q3</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo" id="T9:U80"><span class="var type1" id="S16T9U99">Me</span>=<span class="mxinfo" id="T9:U82"><span class="fcn" id="F1N10:B101">body2ned</span>(<span class="var type1" id="S15T1U102">q_now</span>,<span class="var type1" id="S4T9U103">Mag_data</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo" id="T2:U85"><span class="var type1" id="S18T2U106">Bnorm</span>=<span class="mxinfo" id="T2:U87">sqrt(<span class="mxinfo" id="T2:U88"><span class="mxinfo" id="T2:U89"><span class="mxinfo" id="T2:U90"><span class="var type1" id="S16T9U112">Me</span>(<span class="mxinfo" id="T4:U92">1</span>)</span>^2</span>+<span class="mxinfo" id="T2:U93"><span class="mxinfo" id="T2:U94"><span class="var type1" id="S16T9U117">Me</span>(<span class="mxinfo" id="T4:U96">2</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo" id="T2:U97"><span class="var type1" id="S20T2U122">Me_x</span>=<span class="mxinfo" id="T2:U99"><span class="mxinfo" id="T2:U100"><span class="var type1" id="S16T9U125">Me</span>(<span class="mxinfo" id="T4:U102">1</span>)</span>/<span class="var type1" id="S18T2U127">Bnorm</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo" id="T2:U104"><span class="var type1" id="S21T2U130">Me_y</span>=<span class="mxinfo" id="T2:U106"><span class="mxinfo" id="T2:U107"><span class="var type1" id="S16T9U133">Me</span>(<span class="mxinfo" id="T4:U109">2</span>)</span>/<span class="var type1" id="S18T2U135">Bnorm</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T9:U111"><span class="var type1" id="S16T9U138">Me</span>=<span class="mxinfo" id="T9:U113">[<span class="var type1" id="S20T2U141">Me_x</span>;<span class="var type1" id="S21T2U143">Me_y</span>;<span class="mxinfo" id="T4:U116">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo" id="T9:U117"><span class="var type1" id="S22T9U148">Mb</span>=<span class="mxinfo" id="T9:U119"><span class="fcn" id="F99N15:B150">ned2body</span>(<span class="var type1" id="S15T1U151">q_now</span>,<span class="var type1" id="S16T9U152">Me</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,24" id="srcline24">24</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,26" id="srcline26">26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,27" id="srcline27">27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,28" id="srcline28">28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,30" id="srcline30">30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,31" id="srcline31">31</a></span><span class="line"><span class="mxinfo" id="T4:U122"><span class="mxinfo" id="T4:U123"><span class="var type1" id="S13T18U156">Z</span>(<span class="mxinfo" id="T4:U125">6</span>)</span>=<span class="mxinfo" id="T2:U126"><span class="var type1" id="S22T9U159">Mb</span>(<span class="mxinfo" id="T4:U128">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo" id="T4:U129"><span class="mxinfo" id="T4:U130"><span class="var type1" id="S13T18U164">Z</span>(<span class="mxinfo" id="T4:U132">7</span>)</span>=<span class="mxinfo" id="T2:U133"><span class="var type1" id="S22T9U167">Mb</span>(<span class="mxinfo" id="T4:U135">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,33" id="srcline33">33</a></span><span class="line"><span class="mxinfo" id="T4:U136"><span class="mxinfo" id="T4:U137"><span class="var type1" id="S13T18U172">Z</span>(<span class="mxinfo" id="T4:U139">8</span>)</span>=<span class="mxinfo" id="T2:U140"><span class="var type1" id="S22T9U175">Mb</span>(<span class="mxinfo" id="T4:U142">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,34" id="srcline34">34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,35" id="srcline35">35</a></span><span class="line"><span class="mxinfo" id="T32:U143"><span class="var type1" id="S24T32U179">H</span>=<span class="mxinfo" id="T32:U145"><span class="fcn" id="F126N7:B181">LinearizeH</span>(<span class="var type1" id="S2T14U182">X</span>,<span class="var type1" id="S8T9U183">Be</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,36" id="srcline36">36</a></span><span class="line"><span class="mxinfo" id="T18:U148"><span class="var type1" id="S26T18U186">Y</span>=<span class="mxinfo" id="T18:U150"><span class="fcn" id="F51N12:B188">h</span>(<span class="var type1" id="S2T14U189">X</span>,<span class="var type1" id="S8T9U190">Be</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo" id="T14:U153">[<span class="var type1" id="S2T14U194">X</span> <span class="var type1" id="S3T25U195">P</span>]=<span class="fcn" id="F296N9:B197">SerialUpdate</span>(<span class="var type1" id="S24T32U198">H</span>,<span class="var type1" id="S7T33U199">R</span>,<span class="var type1" id="S13T18U200">Z</span>,<span class="var type1" id="S26T18U201">Y</span>,<span class="var type1" id="S3T25U202">P</span>,<span class="var type1" id="S2T14U203">X</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,38" id="srcline38">38</a></span><span class="line"><span class="mxinfo" id="T14:U162"><span class="var type1" id="S2T14U206">X</span>=<span class="mxinfo" id="T14:U164"><span class="fcn" id="F297N16:B208">normlise_quaternion</span>(<span class="var type1" id="S2T14U209">X</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,39" id="srcline39">39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,40" id="srcline40">40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,41" id="srcline41">41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,42" id="srcline42">42</a></span><span class="line"></span></span>
</pre>
