<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="37,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T14U3">X</span> <span class="var type1" id="S3T25U4">P</span>]=INS_Correction(<span class="var type1" id="S4T9U7">Mag_data</span>,<span class="var type1" id="S5T9U8">Pos</span>,<span class="var type1" id="S6T26U9">Vel</span>,<span class="mxinfo" id="T14:U6"><span class="mxinfo" id="T14:U7"><span class="var type1" id="S2T14U10">X</span></span></span>,<span class="var type1" id="S7T34U11">R</span>,<span class="mxinfo" id="T25:U10"><span class="mxinfo" id="T25:U11"><span class="var type1" id="S3T25U12">P</span></span></span>,<span class="var type1" id="S8T9U13">Be</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="37,2" id="srcline2"> 2</a></span><span class="line"><span class="mxinfo" id="T2:U14"><span class="var type1" id="S9T2U16">q0</span>=<span class="mxinfo" id="T2:U16"><span class="var type1" id="S2T14U18">X</span>(<span class="mxinfo" id="T4:U18">7</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo" id="T2:U19"><span class="var type1" id="S10T2U22">q1</span>=<span class="mxinfo" id="T2:U21"><span class="var type1" id="S2T14U24">X</span>(<span class="mxinfo" id="T4:U23">8</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,4" id="srcline4"> 4</a></span><span class="line"><span class="mxinfo" id="T2:U24"><span class="var type1" id="S11T2U28">q2</span>=<span class="mxinfo" id="T2:U26"><span class="var type1" id="S2T14U30">X</span>(<span class="mxinfo" id="T4:U28">9</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo" id="T2:U29"><span class="var type1" id="S12T2U34">q3</span>=<span class="mxinfo" id="T2:U31"><span class="var type1" id="S2T14U36">X</span>(<span class="mxinfo" id="T4:U33">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo" id="T18:U34"><span class="var type1" id="S13T18U40">Z</span>=<span class="mxinfo" id="T18:U36">zeros(<span class="mxinfo" id="T4:U37">8</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo" id="T4:U38"><span class="mxinfo" id="T4:U39"><span class="var type1" id="S13T18U48">Z</span>(<span class="mxinfo" id="T4:U41">1</span>)</span>=<span class="mxinfo" id="T2:U42"><span class="var type1" id="S5T9U51">Pos</span>(<span class="mxinfo" id="T4:U44">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T4:U45"><span class="mxinfo" id="T4:U46"><span class="var type1" id="S13T18U56">Z</span>(<span class="mxinfo" id="T4:U48">2</span>)</span>=<span class="mxinfo" id="T2:U49"><span class="var type1" id="S5T9U59">Pos</span>(<span class="mxinfo" id="T4:U51">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T4:U52"><span class="mxinfo" id="T4:U53"><span class="var type1" id="S13T18U64">Z</span>(<span class="mxinfo" id="T4:U55">3</span>)</span>=<span class="mxinfo" id="T2:U56"><span class="var type1" id="S5T9U67">Pos</span>(<span class="mxinfo" id="T4:U58">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T4:U59"><span class="mxinfo" id="T4:U60"><span class="var type1" id="S13T18U72">Z</span>(<span class="mxinfo" id="T4:U62">4</span>)</span>=<span class="mxinfo" id="T2:U63"><span class="var type1" id="S6T26U75">Vel</span>(<span class="mxinfo" id="T4:U65">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo" id="T4:U66"><span class="mxinfo" id="T4:U67"><span class="var type1" id="S13T18U80">Z</span>(<span class="mxinfo" id="T4:U69">5</span>)</span>=<span class="mxinfo" id="T2:U70"><span class="var type1" id="S6T26U83">Vel</span>(<span class="mxinfo" id="T4:U72">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,13" id="srcline13">13</a></span><span class="line"><span class="comment">% %% do lots of things to remove megnetic Z value</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,14" id="srcline14">14</a></span><span class="line"><span class="comment">% % Bnorm=sqrt(Mag_data(1)^2+Mag_data(2)^2+Mag_data(3)^2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,15" id="srcline15">15</a></span><span class="line"><span class="comment">% % Mb_x=Mag_data(1)/Bnorm;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,16" id="srcline16">16</a></span><span class="line"><span class="comment">% % Mb_y=Mag_data(2)/Bnorm;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,17" id="srcline17">17</a></span><span class="line"><span class="comment">% % Mb_z=Mag_data(3)/Bnorm;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,18" id="srcline18">18</a></span><span class="line"><span class="comment">% %body frame to earth frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,19" id="srcline19">19</a></span><span class="line"><span class="comment">% Mbe=[q0^2+q1^2-q2^2-q3^2,2*(q1*q2+q0*q3),2*(q1*q3-q0*q2);2*(q1*q2-q0*q3),q0^2-q1^2+q2^2-q3^2,2*(q2*q3+q0*q1);2*(q1*q3+q0*q2),2*(q2*q3-q0*q1),q0^2-q1^2-q2^2+q3^2];</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,20" id="srcline20">20</a></span><span class="line"><span class="comment">% %earth frame to body frame and remove z value</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,21" id="srcline21">21</a></span><span class="line"><span class="comment">% Meb=Mbe';</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,22" id="srcline22">22</a></span><span class="line"><span class="comment">% Mned_x=Meb(1,1)*Mag_data(1) + Meb(1,2)*Mag_data(2) + Meb(1,3)*Mag_data(3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,23" id="srcline23">23</a></span><span class="line"><span class="comment">% Mned_y=Meb(2,1)*Mag_data(1) + Meb(2,2)*Mag_data(2) + Meb(2,3)*Mag_data(3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,24" id="srcline24">24</a></span><span class="line"><span class="comment">% %normlize it </span></span></span>
<span class="srcline"><span class="lineno"><a href="37,25" id="srcline25">25</a></span><span class="line"><span class="comment">% Bnorm=sqrt(Mned_x^2+Mned_y^2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,26" id="srcline26">26</a></span><span class="line"><span class="comment">% Mned_x=Mag_data(1)/Bnorm;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,27" id="srcline27">27</a></span><span class="line"><span class="comment">% Mned_y=Mag_data(2)/Bnorm;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,28" id="srcline28">28</a></span><span class="line"><span class="comment">% %transfer megnetic to body frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,29" id="srcline29">29</a></span><span class="line"><span class="comment">% Mb_x=Mbe(1,1)*Mned_x + Mbe(1,2)*Mned_y;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,30" id="srcline30">30</a></span><span class="line"><span class="comment">% Mb_y=Mbe(2,1)*Mned_x + Mbe(2,2)*Mned_y;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,31" id="srcline31">31</a></span><span class="line"><span class="comment">% Mb_z=Mbe(3,1)*Mned_x + Mbe(3,2)*Mned_y;</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,32" id="srcline32">32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,34" id="srcline34">34</a></span><span class="line"><span class="comment">%%This is original openpilot method</span></span></span>
<span class="srcline"><span class="lineno"><a href="37,35" id="srcline35">35</a></span><span class="line"><span class="mxinfo" id="T2:U73"><span class="var type1" id="S15T2U87">Bnorm</span>=<span class="mxinfo" id="T2:U75">sqrt(<span class="mxinfo" id="T2:U76"><span class="mxinfo" id="T2:U77"><span class="mxinfo" id="T2:U78"><span class="mxinfo" id="T2:U79"><span class="var type1" id="S4T9U94">Mag_data</span>(<span class="mxinfo" id="T4:U81">1</span>)</span>^2</span>+<span class="mxinfo" id="T2:U82"><span class="mxinfo" id="T2:U83"><span class="var type1" id="S4T9U99">Mag_data</span>(<span class="mxinfo" id="T4:U85">2</span>)</span>^2</span></span>+<span class="mxinfo" id="T2:U86"><span class="mxinfo" id="T2:U87"><span class="var type1" id="S4T9U104">Mag_data</span>(<span class="mxinfo" id="T4:U89">3</span>)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,36" id="srcline36">36</a></span><span class="line"><span class="mxinfo" id="T2:U90"><span class="var type1" id="S17T2U109">Mb_x</span>=<span class="mxinfo" id="T2:U92"><span class="mxinfo" id="T2:U93"><span class="var type1" id="S4T9U112">Mag_data</span>(<span class="mxinfo" id="T4:U95">1</span>)</span>/<span class="var type1" id="S15T2U114">Bnorm</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo" id="T2:U97"><span class="var type1" id="S18T2U117">Mb_y</span>=<span class="mxinfo" id="T2:U99"><span class="mxinfo" id="T2:U100"><span class="var type1" id="S4T9U120">Mag_data</span>(<span class="mxinfo" id="T4:U102">2</span>)</span>/<span class="var type1" id="S15T2U122">Bnorm</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,38" id="srcline38">38</a></span><span class="line"><span class="mxinfo" id="T2:U104"><span class="var type1" id="S19T2U125">Mb_z</span>=<span class="mxinfo" id="T2:U106"><span class="mxinfo" id="T2:U107"><span class="var type1" id="S4T9U128">Mag_data</span>(<span class="mxinfo" id="T4:U109">3</span>)</span>/<span class="var type1" id="S15T2U130">Bnorm</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,39" id="srcline39">39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,40" id="srcline40">40</a></span><span class="line"><span class="mxinfo" id="T4:U111"><span class="mxinfo" id="T4:U112"><span class="var type1" id="S13T18U134">Z</span>(<span class="mxinfo" id="T4:U114">6</span>)</span>=<span class="var type1" id="S17T2U136">Mb_x</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,41" id="srcline41">41</a></span><span class="line"><span class="mxinfo" id="T4:U116"><span class="mxinfo" id="T4:U117"><span class="var type1" id="S13T18U140">Z</span>(<span class="mxinfo" id="T4:U119">7</span>)</span>=<span class="var type1" id="S18T2U142">Mb_y</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,42" id="srcline42">42</a></span><span class="line"><span class="mxinfo" id="T4:U121"><span class="mxinfo" id="T4:U122"><span class="var type1" id="S13T18U146">Z</span>(<span class="mxinfo" id="T4:U124">8</span>)</span>=<span class="var type1" id="S19T2U148">Mb_z</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,43" id="srcline43">43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,44" id="srcline44">44</a></span><span class="line"><span class="mxinfo" id="T33:U126"><span class="var type1" id="S20T33U151">H</span>=<span class="mxinfo" id="T33:U128"><span class="fcn" id="F125N7:B153">LinearizeH</span>(<span class="var type1" id="S2T14U154">X</span>,<span class="var type1" id="S8T9U155">Be</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,45" id="srcline45">45</a></span><span class="line"><span class="mxinfo" id="T18:U131"><span class="var type1" id="S22T18U158">Y</span>=<span class="mxinfo" id="T18:U133"><span class="fcn" id="F126N12:B160">h</span>(<span class="var type1" id="S2T14U161">X</span>,<span class="var type1" id="S8T9U162">Be</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo" id="T14:U136">[<span class="var type1" id="S2T14U166">X</span> <span class="var type1" id="S3T25U167">P</span>]=<span class="fcn" id="F296N9:B169">SerialUpdate</span>(<span class="var type1" id="S20T33U170">H</span>,<span class="var type1" id="S7T34U171">R</span>,<span class="var type1" id="S13T18U172">Z</span>,<span class="var type1" id="S22T18U173">Y</span>,<span class="var type1" id="S3T25U174">P</span>,<span class="var type1" id="S2T14U175">X</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,47" id="srcline47">47</a></span><span class="line"><span class="mxinfo" id="T14:U145"><span class="var type1" id="S2T14U178">X</span>=<span class="mxinfo" id="T14:U147"><span class="fcn" id="F297N16:B180">normlise_quaternion</span>(<span class="var type1" id="S2T14U181">X</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="37,48" id="srcline48">48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,49" id="srcline49">49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,50" id="srcline50">50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="37,51" id="srcline51">51</a></span><span class="line"></span></span>
</pre>
