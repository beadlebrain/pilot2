<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="89,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T2U3">X</span> <span class="var type1" id="S3T20U4">P</span>]=SerialUpdate(<span class="var type1" id="S4T29U7">H</span>,<span class="var type1" id="S5T30U8">R</span>,<span class="var type1" id="S6T10U9">Z</span>,<span class="var type1" id="S7T10U10">Y</span>,<span class="mxinfo" id="T20:U7"><span class="mxinfo" id="T20:U8"><span class="var type1" id="S3T20U11">P</span></span></span>,<span class="mxinfo" id="T2:U10"><span class="mxinfo" id="T2:U11"><span class="var type1" id="S2T2U12">X</span></span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="89,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% // *************  SerialUpdate *******************</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% // Does the update step of the Kalman filter for the covariance and estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% // Outputs are Xnew &amp; Pnew, and are written over P and X</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% // Z is actual measurement, Y is predicted measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% // Xnew = X + K*(Z-Y), Pnew=(I-K*H)*P,</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% // where K=P*H'*inv[H*P*H'+R]</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% // NOTE the algorithm assumes R (measurement covariance matrix) is diagonal</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% // i.e. the measurment noises are uncorrelated.</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,10" id="srcline10">10</a></span><span class="line"><span class="comment">% // It therefore uses a serial update that requires no matrix inversion by</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,11" id="srcline11">11</a></span><span class="line"><span class="comment">% // processing the measurements one at a time.</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,12" id="srcline12">12</a></span><span class="line"><span class="comment">% // Algorithm - see Grewal and Andrews, "Kalman Filtering,2nd Ed" p.121 &amp; p.253</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,13" id="srcline13">13</a></span><span class="line"><span class="comment">% // - or see Simon, "Optimal State Estimation," 1st Ed, p.150</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,14" id="srcline14">14</a></span><span class="line"><span class="comment">% // The SensorsUsed variable is a bitwise mask indicating which sensors</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,15" id="srcline15">15</a></span><span class="line"><span class="comment">% // should be used in the update.</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,16" id="srcline16">16</a></span><span class="line"><span class="comment">% // ************************************************</span></span></span>
<span class="srcline"><span class="lineno"><a href="89,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo" id="T32:U13"><span class="var type1" id="S8T32U15">K</span>=<span class="mxinfo" id="T32:U15"><span class="mxinfo" id="T32:U16"><span class="var type1" id="S3T20U18">P</span>*<span class="mxinfo" id="T31:U18"><span class="var type1" id="S4T29U20">H</span>'</span></span>*<span class="mxinfo" id="T30:U20">inv(<span class="mxinfo" id="T30:U21"><span class="mxinfo" id="T30:U22"><span class="mxinfo" id="T33:U23"><span class="var type1" id="S4T29U26">H</span>*<span class="var type1" id="S3T20U27">P</span></span>*<span class="mxinfo" id="T31:U26"><span class="var type1" id="S4T29U29">H</span>'</span></span>+<span class="var type1" id="S5T30U30">R</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="89,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo" id="T2:U29"><span class="var type1" id="S2T2U33">X</span>=<span class="mxinfo" id="T2:U31"><span class="var type1" id="S2T2U35">X</span>+<span class="mxinfo" id="T2:U33"><span class="var type1" id="S8T32U37">K</span>*(<span class="mxinfo" id="T10:U35"><span class="var type1" id="S6T10U40">Z</span>-<span class="var type1" id="S7T10U41">Y</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="89,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo" id="T20:U38"><span class="var type1" id="S3T20U44">P</span>=<span class="mxinfo" id="T20:U40"><span class="var type1" id="S3T20U46">P</span>-<span class="mxinfo" id="T20:U42"><span class="mxinfo" id="T20:U43"><span class="var type1" id="S8T32U49">K</span>*<span class="var type1" id="S4T29U50">H</span></span>*<span class="var type1" id="S3T20U51">P</span></span></span></span>;</span></span>
</pre>
